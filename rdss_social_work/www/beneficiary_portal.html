{% extends "templates/web.html" %}

{% block title %}{{ title or "Beneficiary Portal" }}{% endblock %}

{% block page_content %}
<div class="container mt-4">
    {% if beneficiary %}
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fa fa-user-circle"></i> Welcome, {{ beneficiary.beneficiary_name or "Beneficiary" }}
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Primary Diagnosis:</strong> {{ beneficiary.primary_diagnosis or "Not specified" }}</p>
                            <p><strong>Status:</strong> 
                                <span class="badge badge-{% if beneficiary.current_status == 'Active' %}success{% else %}secondary{% endif %}">
                                    {{ beneficiary.current_status or "Unknown" }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Beneficiary ID:</strong> {{ beneficiary.name or "Not available" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning">
                <h4><i class="fa fa-exclamation-triangle"></i> Access Issue</h4>
                <p>Unable to load beneficiary information. Please ensure you are logged in with a valid beneficiary account.</p>
                <a href="/login" class="btn btn-primary">Login</a>
                <a href="/beneficiary_signup" class="btn btn-outline-primary">Register</a>
            </div>
        </div>
    </div>
    {% endif %}

    {% if beneficiary %}
    <!-- Upcoming Appointments Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fa fa-calendar-alt"></i> Upcoming Appointments</h5>
                </div>
                <div class="card-body">
                    {% if upcoming_appointments %}
                        <div class="row">
                            {% for appointment in upcoming_appointments %}
                            <div class="col-md-4 mb-3">
                                <div class="card border-left-info h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">{{ appointment.appointment_type }}</h6>
                                            <span class="badge badge-{% if appointment.appointment_status == 'Confirmed' %}success{% else %}warning{% endif %} badge-sm">
                                                {{ appointment.appointment_status }}
                                            </span>
                                        </div>
                                        
                                        <div class="appointment-details">
                                            <p class="mb-2">
                                                <i class="fa fa-calendar text-primary"></i>
                                                <strong>{{ frappe.format_date(appointment.appointment_date, "dd MMM yyyy") }}</strong>
                                            </p>
                                            <p class="mb-2">
                                                <i class="fa fa-clock text-primary"></i>
                                                {{ appointment.appointment_time }}
                                                {% if appointment.duration_minutes %}
                                                    ({{ appointment.duration_minutes }} min)
                                                {% endif %}
                                            </p>
                                            <p class="mb-2">
                                                <i class="fa fa-map-marker-alt text-primary"></i>
                                                {{ appointment.location_type or "Not specified" }}
                                                {% if appointment.appointment_location %}
                                                    <br><small class="text-muted">{{ appointment.appointment_location }}</small>
                                                {% endif %}
                                            </p>
                                            <p class="mb-2">
                                                <i class="fa fa-user-tie text-primary"></i>
                                                {{ appointment.social_worker_name }}
                                            </p>
                                            {% if appointment.purpose %}
                                            <p class="mb-2">
                                                <i class="fa fa-info-circle text-primary"></i>
                                                <small>{{ appointment.purpose[:100] }}{% if appointment.purpose|length > 100 %}...{% endif %}</small>
                                            </p>
                                            {% endif %}
                                            {% if appointment.special_instructions %}
                                            <div class="alert alert-warning alert-sm p-2 mb-0">
                                                <small><strong>Note:</strong> {{ appointment.special_instructions }}</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fa fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No upcoming appointments scheduled</h6>
                            <p class="text-muted small">Your social worker will schedule appointments as needed. You will receive notifications when new appointments are scheduled.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fa fa-clipboard-list"></i> Available Support Schemes</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if schemes %}
                        {% for scheme in schemes %}
                        <div class="col-md-6 mb-3">
                            <div class="card border-left-primary h-100">
                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title">{{ scheme.name }}</h6>
                                    <p class="card-text small flex-grow-1">{{ scheme.description }}</p>
                                    <p class="text-muted small mb-3">
                                        <i class="fa fa-calendar"></i> Deadline: {{ scheme.deadline }}
                                    </p>
                                    <div class="text-center mt-auto">
                                        {% set scheme_key = "Medical Intervention Scheme (MIS)" if scheme.name == "Medical Intervention Support" else scheme.name %}
                                        {% if existing_scheme_applications.get(scheme_key) %}
                                            <button class="btn btn-secondary btn-sm" disabled>
                                                <i class="fa fa-check"></i> Already Applied
                                            </button>
                                            <small class="d-block text-muted mt-1">Status: {{ existing_scheme_applications[scheme_key].status }}</small>
                                        {% else %}
                                            <a href="{{ scheme.route or '/medical_intervention_application' }}" class="btn btn-primary btn-sm">
                                                <i class="fa fa-plus"></i> Apply Now
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="col-12">
                            <p class="text-muted">No support schemes available at this time.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fa fa-history"></i> My Applications</h5>
                </div>
                <div class="card-body">
                    {% if recent_applications %}
                        {% for app in recent_applications %}
                        <div class="border-bottom pb-2 mb-2">
                            <h6 class="mb-1">{{ app.scheme_type }}</h6>
                            <p class="small mb-1">
                                <strong>Status:</strong> 
                                <span class="badge badge-{% if app.application_status == 'Approved' %}success{% elif app.application_status == 'Rejected' %}danger{% elif app.application_status == 'Submitted' %}warning{% else %}secondary{% endif %}">
                                    {{ app.application_status }}
                                </span>
                            </p>
                            <p class="small mb-1">
                                <strong>Applied:</strong> {{ frappe.format_date(app.application_date) }}
                            </p>
                            {% if app.approved_amount and app.approved_amount > 0 %}
                            <p class="small mb-1">
                                <strong>Approved Amount:</strong> ${{ app.approved_amount }}
                            </p>
                            {% endif %}
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="/application_view?id={{ app.name }}" class="btn btn-outline-primary btn-xs">
                                    View Details
                                </a>
                                {% if app.application_status in ['Draft', 'Submitted', 'Under Admin Review'] %}
                                <button type="button" class="btn btn-outline-danger btn-xs" onclick="cancelApplication('{{ app.name }}', '{{ app.scheme_type }}')">
                                    Cancel
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No applications submitted yet.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fa fa-info-circle"></i> Important Information</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li><i class="fa fa-check text-success"></i> All applications must be submitted by 30 April</li>
                        <li><i class="fa fa-check text-success"></i> Supporting documents are required</li>
                        <li><i class="fa fa-check text-success"></i> Applications are reviewed by admin then director</li>
                        <li><i class="fa fa-check text-success"></i> You will receive email notifications on status updates</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Add loading states and error handling for navigation
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for application links
    const appLinks = document.querySelectorAll('a[href*="/medical_intervention_application"]');
    appLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Loading...';
            btn.disabled = true;
            
            // Reset after a delay if page doesn't navigate
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 5000);
        });
    });
    
    // Add error handling for any failed loads
    window.addEventListener('error', function(e) {
        console.error('Page error:', e.error);
        frappe.msgprint({
            title: 'Error',
            message: 'An error occurred. Please refresh the page and try again.',
            indicator: 'red'
        });
    });
    
    // Check for any missing beneficiary data
    const beneficiaryName = document.querySelector('input[readonly]');
    if (beneficiaryName && (!beneficiaryName.value || beneficiaryName.value === 'Loading...')) {
        setTimeout(() => {
            if (!beneficiaryName.value || beneficiaryName.value === 'Loading...') {
                frappe.msgprint({
                    title: 'Loading Issue',
                    message: 'There seems to be an issue loading your profile. Please refresh the page.',
                    indicator: 'orange'
                });
            }
        }, 3000);
    }
});

// Cancel application function
function cancelApplication(applicationName, schemeType) {
    frappe.confirm(
        `Are you sure you want to cancel your ${schemeType} application? This action cannot be undone.`,
        function() {
            frappe.call({
                method: 'rdss_social_work.api.cancel_application',
                args: {
                    application_name: applicationName
                },
                callback: function(r) {
                    if (r.message && r.message.status === 'success') {
                        frappe.msgprint({
                            title: 'Success',
                            message: 'Application cancelled successfully!',
                            indicator: 'green'
                        });
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        frappe.msgprint({
                            title: 'Error',
                            message: r.message?.message || 'Failed to cancel application. Please try again.',
                            indicator: 'red'
                        });
                    }
                },
                error: function(r) {
                    frappe.msgprint({
                        title: 'Error',
                        message: 'Network error. Please check your connection and try again.',
                        indicator: 'red'
                    });
                }
            });
        }
    );
}
</script>

<style>
.border-left-primary {
    border-left: 4px solid #007bff !important;
}

.card {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    border: 1px solid #e3e6f0;
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.2);
}

.btn-xs {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.badge {
    font-size: 0.75em;
}

/* Ensure uniform card heights */
.h-100 {
    height: 100% !important;
}

/* Welcome header styling */
.card-header.bg-primary {
    background: linear-gradient(135deg, #832061 0%, #6a1a4f 100%) !important;
    border: none;
}

.card-header.bg-primary h4 {
    color: white !important;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* Compact and uniform scheme cards */
.border-left-primary .card-body {
    padding: 1.25rem;
}

.border-left-primary .card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.75rem;
}

.border-left-primary .card-text {
    color: #6c757d;
    line-height: 1.4;
    margin-bottom: 0.75rem;
}

/* Appointment section styling */
.border-left-info {
    border-left: 4px solid #832061 !important;
}

.card-header.bg-info {
    background: linear-gradient(135deg, #832061 0%, #6a1a4f 100%) !important;
    border: none;
}
/* Ensure white header text for better contrast */
.card-header.bg-info,
.card-header.bg-info h5,
.card-header.bg-info i {
    color: #ffffff !important;
}

.appointment-details p {
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.appointment-details i {
    width: 16px;
    margin-right: 8px;
    color: #832061 !important;
}

.alert-sm {
    font-size: 0.8rem;
    padding: 0.5rem !important;
}

.badge-sm {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}
</style>
{% endblock %}
